# Дорожная карта миграции зеркала nlping.ru

> Этот документ — единый источник правды (Single Source of Truth) о том, как выполняется миграция зеркала `nlping.ru`. Когда в
> переписке упоминается «дорожная карта», речь идёт именно об этом файле. Разделы ниже включают описание подхода, подробный
> план, журнал прогресса и чек-листы проверок.

## Контекст и цели

Cloudflare Pages отдаёт статический бэкап сайта `nlping.ru`, скачанный через HTTrack. На зеркале остались две ключевые проблемы:

1. **Дублирование сегмента `nlping.ru` в URL**. Контент находится в подкаталоге `nlping.ru/`, поэтому реальные страницы открываются как `/nlping.ru/...`, а при подключении боевого домена получится нежелательное `nlping.ru/nlping.ru/...`.
2. **Неверная кодировка контента**. HTML и XML внутри `nlping.ru/` сохранены в Windows-1251, а Cloudflare Pages по умолчанию отдаёт `charset=utf-8`, из-за чего текст искажается.

Цель — привести зеркало к структуре «корень = сайт», перевести весь контент в UTF-8, сохранить SEO-метрики и обеспечить автоматические проверки, чтобы не повторить прошлую ошибку с слишком крупными, непроверяемыми диффами.

## Основные задачи

1. **Устранить дублирование `nlping.ru` в путях.** Перенести содержимое подкаталога `nlping.ru/` в корень репозитория, настроить корректный `index.html`, очистить артефакты HTTrack.
2. **Перевести контент в UTF-8.** Безопасно перекодировать HTML/XML из CP1251 → UTF-8, обновить мета-теги и декларации, убедиться, что страницы и RSS валидны.

## Рассмотренные варианты и выбор

| Вариант | Суть | Плюсы | Ограничения |
| --- | --- | --- | --- |
| A | Оставить структуру как есть и выдавать `charset=windows-1251` через `_headers`. | Быстрый патч, минимум кода. | Сохраняет устаревшую кодировку, требует постоянного контроля правил, не решает дублирование `/nlping.ru/` в URL. |
| B | Перекодировать все HTML/XML в UTF-8, не трогая структуру. | Совместимо с Cloudflare Pages, убирает проблему кодировки. | URL остаются с префиксом `/nlping.ru/`, поддержка зеркала остаётся неудобной. |
| C | Перенести содержимое `nlping.ru/` в корень и сразу перекодировать в UTF-8 с автоматическими проверками. | Устраняет дублирование URL и проблему кодировки, делает структуру очевидной, снижает технический долг. | Требует аккуратной миграции и надёжных скриптов, иначе можно испортить контент или SEO. |

**Выбран вариант C.** На dev-сайте нет трафика, поэтому можно сразу привести зеркало к финальной структуре и кодировке. Риски управляемы: перед каждой партией есть снапшоты, автоматические проверки и журнал для откатов.

## Подход (рабочие принципы против перегрузки)

- **Минимальные партии.** Каждое изменение выполняется маленькой законченной задачей (не более ~150 файлов в коммите; при перекодировке — одна поддиректория за итерацию).
- **Двойной контур проверок.** Для каждого шага: автоматический скрипт (чексуммы, поиск `windows-1251`, обход sitemap) + выборочная ручная проверка ключевых страниц.
- **Постоянные точки отката.** После каждой подзадачи — коммит и запись в журнал. При проблеме можно откатиться без потери контекста.
- **Документирование прогресса.** Фиксировать в этой дорожной карте и в сопутствующих памятках, что сделано и какие артефакты созданы.
- **Контроль диффов.** Перед коммитом проверять `git diff --stat` и объём. Если партия слишком большая, дробить дальше.
- **Артефакты baseline — только локально.** Слепки, контрольные суммы и отчёты генерируем в `snapshot/` и `logs/`, эти каталоги внесены в `.gitignore`, чтобы коммиты открывались мгновенно и не появлялась ошибка огромного диффа.
- **Учитываем отсутствие трафика.** Нет активных посетителей на dev-версии — значит, временные заплатки можно пропустить и сразу двигаться к финальной структуре и кодировке, но при этом сохраняем автоматизированные проверки, чтобы не потерять контент/SEO.

## Дорожная карта

### Этап A. База и страхующие артефакты

| Код | Шаг | Проверки и артефакты | Статус |
| --- | --- | --- | --- |
| A1 | Зафиксировать подход и правила работы (этот файл `DOROZHNAYA_KARTA.md`). | Проверка: `cat DOROZHNAYA_KARTA.md`, ревью; артефакт: `DOROZHNAYA_KARTA.md`. | ✅ Выполнено (коммит `Add baseline checksums for nlping.ru`). |
| A2 | Снять baseline контрольных сумм для `nlping.ru`. | Команда: `python tools/generate_md5_baseline.py` → `snapshot/baseline_md5.txt.gz` (артефакт не хранится в git). | ✅ Выполнено (коммит `Add baseline checksums for nlping.ru`, обновлено скриптом). |
| A3 | Сформировать манифест URL (sitemap, RSS, ключевые страницы) → `tools/url_manifest.txt`. | Проверка: `wc -l tools/url_manifest.txt`. | ✅ Выполнено — манифест создан (`tools/url_manifest.txt`). |
| A4 | Снять оффлайн-слепок для SEO-сравнения → каталог `snapshot/` + выгруженные `<title>/<meta>`. | Проверка: команда `tar -czf snapshot/nlping_ru_snapshot.tar.gz nlping.ru` и `python tools/generate_seo_baseline.py` → `snapshot/seo_baseline.json.gz`; оба артефакта остаются локально (в git только `.gitkeep`). | ✅ Выполнено — локальный слепок и SEO-бейзлайн генерируются по запросу и не коммитятся. |
| A5 | Описать постоянные памятки (MB-01…MB-07) и рабочую инструкцию выполнения (`INSTRUKTSIYA_VYPOLNENIYA.md`). | Проверка: файлы созданы, ссылка из дорожной карты. | ✅ Выполнено — памятки лежат в `memory-bank/MB-*.md`. |

### Этап B. Инструменты проверки и страховки

| Код | Шаг | Проверки и артефакты | Статус |
| --- | --- | --- | --- |
| B1 | Скрипт `tools/list_assets.py` — собрать зависимости страниц (CSS/JS/изображения). | Артефакт: `artifacts/assets.json`. | ✅ Выполнено — скрипт собирает 2169 HTML-файлов, формируя карту ресурсов (`python tools/list_assets.py` → `artifacts/assets.json`). |
| B2 | Скрипт `tools/check_links.py` — локальная проверка ссылок/ресурсов по каталогу или manifest. | Проверка: прогон `python tools/check_links.py --scope nlping.ru/index.html` → лог `logs/check_links-20250923T200035Z.json` (все ресурсы на месте, устаревший `s.nlping.ru/jsapi/click.js` удалён). | ✅ Выполнено — скрипт контролирует ссылки, база очищена от битой интеграции. |
| B3 | Скрипт `tools/check_utf8.py` — валидация кодировки, поиск `�`, сравнение SEO-блоков со слепком. | Проверка: отчёт `logs/check_utf8-*.json`. | ⏳ Не начато. |

### Этап C. Перенос структуры (устранение `/nlping.ru/` в URL)

| Код | Шаг | Проверки и артефакты | Статус |
| --- | --- | --- | --- |
| C1 | Перенести корневые HTML (`index.html`, `news.html`, …) из `nlping.ru/` в корень, настроить главный `index.html`. | Проверка: локальный `python -m http.server`, ручная проверка главной. | ⏳ Не начато. |
| C2 | Перемещать каталоги партиями (`css/`, `images/`, `js/`, `p/…`) с промежуточными проверками `tools/check_links.py`. | Проверка: отчёты скрипта, ручная выборка. | ⏳ Не начато. |
| C3 | Очистить остатки HTTrack (индекс каталога, пустые директории), обновить ссылки в README. | Проверка: `find nlping.ru -maxdepth 1` → пусто. | ⏳ Не начато. |

### Этап D. Перекодировка в UTF-8 (по партиям)

| Код | Шаг | Проверки и артефакты | Статус |
| --- | --- | --- | --- |
| D0 | Написать `tools/reencode.py` (CP1251 → UTF-8) + модульные тесты `tools/tests/test_reencode.py`. | Проверка: `pytest tools/tests/test_reencode.py`. | ⏳ Не начато. |
| D1 | Первая партия (корневые HTML, RSS, критичные страницы). | Проверки: `tools/reencode.py`, `rg -n "windows-1251"`, ручной просмотр. | ⏳ Не начато. |
| D2…Dn | Остальные директории (`p/0*`, `p/1*`, …) — не более 150 файлов за итерацию. | Проверки: `tools/check_utf8.py --scope <dir>`, выборка страниц. | ⏳ Не начато. |
| Dlast | Финальная валидация: `rg -n "windows-1251" .` → пусто; полный прогон `tools/check_utf8.py --manifest`. | Артефакты: лог проверки, обновлённые контрольные суммы. | ⏳ Не начато. |

### Этап E. Деплой и верификация

| Код | Шаг | Проверки и артефакты | Статус |
| --- | --- | --- | --- |
| E1 | Прогон локальных smoke-тестов (HTTP-сервер + `tools/check_links.py`, `tools/check_utf8.py`). | Проверка: отчёты без ошибок. | ⏳ Не начато. |
| E2 | Деплой на Cloudflare Pages, `Purge Everything`, прогон тестов по доменам Pages и `nlping.ru`. | Проверка: `curl -I` → `charset=utf-8`, отчёты скриптов. | ⏳ Не начато. |
| E3 | Обновить документацию (README, дорожная карта, мониторинг), приложить результаты проверок. | Проверка: ревью документации. | ⏳ Не начато. |
| E4 | Настроить охрану (CI-скрипт, запрещающий `windows-1251`, и напоминание о мониторинге). | Проверка: тестовый коммит с запрещённой строкой → CI падает. | ⏳ Не начато. |

## Риски и способы их закрыть

| Риск | Когда может возникнуть | Как предотвращаем |
| --- | --- | --- |
| Повреждение файлов при перекодировке | Ошибка скрипта или неверная партия | Сначала прогоняем на копии, ведём логи `logs/reencode-*.json`, baseline пересчитываем командой `python tools/generate_md5_baseline.py` (артефакт лежит в `snapshot/` вне git) и держим слепок для отката. |
| Потеря ссылок/ресурсов после переноса | При переносе каталогов и HTML в корень | Используем `tools/list_assets.py` и `tools/check_links.py` после каждой партии, ручная выборка страниц из критичных разделов. |
| Изменение SEO-тегов | При рефакторинге структуры или перекодировке | Сравниваем `<title>`, `meta description`, `h1` с оффлайн-слепком (этап A4) с помощью `tools/check_utf8.py`. |
| Остатки `windows-1251` в кодовой базе | Кто-то добавил старый файл или патч неполный | `rg -n "windows-1251"` в рамках проверки, финальная валидация `tools/check_utf8.py --manifest`, настройка CI (E4). |
| Ошибки Cloudflare кэша | После деплоя отдаются старые файлы | Всегда выполняем `Purge Everything` и проверяем через `curl -I` с `Cache-Control: no-cache`, плюс smoke-тест по Pages-домену и боевому домену. |

## Памятки (memory-bank), которые нужно создать на этапе A5

- **MB-01 — Контекст и цель.** Краткая формулировка задачи миграции и критериев успеха.
- **MB-02 — Рабочие принципы.** Напоминание о партии изменений, проверках и журнале.
- **MB-03 — Бэкапы и baseline.** Команды для снапшота, контрольных сумм и их расположение.
- **MB-04 — Перенос структуры.** Чек-лист `git mv`, порядок перемещения каталогов, что проверять.
- **MB-05 — Перекодировка.** Как запускать `tools/reencode.py`, лимиты партий, что делать при ошибке.
- **MB-06 — Проверки и сравнение SEO.** Применение `tools/check_links.py`, `tools/check_utf8.py`, как интерпретировать отчёты.
- **MB-07 — Деплой и охрана.** Порядок деплоя на Cloudflare Pages, команды для `Purge`, описание мониторинга/CI.

## Инструкция для выполнения (промпт для агента)

1. Открой `DOROZHNAYA_KARTA.md` и памятки MB-01…MB-07 (после их создания на этапе A5), чтобы освежить контекст.
2. Выполняй этапы A→E последовательно. На каждом шаге: маленькая партия → автоматическая проверка → ручная выборка → коммит → обновление журнала.
3. Используй инструменты из этапа B для контроля: сначала `tools/list_assets.py`, затем `tools/check_links.py` и `tools/check_utf8.py` перед переходом к следующему этапу.
4. При сбое сразу откатывайся к последнему чистому коммиту, обновляй журнал причинами, корректируй план (при необходимости добавь новую строку в таблицы).
5. После завершения всей миграции удали временные артефакты, обнови документацию и настрой охрану, чтобы `windows-1251` не вернулся.


## Журнал прогресса

| Дата и время (UTC) | Шаги | Проверки | Итог |
| --- | --- | --- | --- |
| 2025-09-22T18:21:46Z | A1 — оформление дорожной карты, A2 — baseline MD5 | Ревью `DOROZHNAYA_KARTA.md`, `baseline_md5.txt` создан | ✅ Подтверждено. |
| 2025-09-22T18:25:00Z | Подготовка к новой итерации: переименовал документ в дорожную карту, уточнил разделы, подтвердил требования по логированию прогресса | `git mv PODHOD.md DOROZHNAYA_KARTA.md`, проверка ссылок на файл, актуализация таблиц | ✅ Документ синхронизирован с новыми инструкциями. |
| 2025-09-22T18:36:15Z | Актуализация дорожной карты под условия dev-сайта без трафика, детализация вариантов и рисков, добавление задач по инструментам и памяткам | Обновлены разделы «Рассмотренные варианты», «Дорожная карта», «Риски», добавлены ссылки на будущие памятки и инструкцию | ✅ Готов к запуску этапа A3. |
| 2025-09-23T14:59:36Z | A5 — созданы памятки memory-bank (MB-01…MB-07) с инструкциями по каждому блоку миграции | Проверка: `ls memory-bank/MB-*.md`, обновление статуса A5 в дорожной карте | ✅ Памятки готовы, можно переходить к A3. |
| 2025-09-23T15:00:19Z | A3 — сформирован манифест ключевых URL для автоматических проверок | Проверка: `wc -l tools/url_manifest.txt` → 26 строк, ручная выборка ссылок с главной | ✅ Манифест готов, следующий шаг — A4 (оффлайн-слепок). |
| 2025-09-23T16:07:58Z | A4 — оффлайн-слепок и SEO-бейзлайн (без доступа к внешней сети) | Попытка `wget --mirror https://nlping.ru/` → отказ прокси; вместо этого создан архив `snapshot/nlping_ru_snapshot.tar.gz` и локальный `snapshot/seo_baseline.json.gz` через `python tools/generate_seo_baseline.py` | ✅ Слепок зафиксирован, можно переходить к этапу B1 (инструменты проверок). |
| 2025-09-23T17:53:43Z | A2/A4 — перевёл baseline в сжатые локальные артефакты | Проверка: `python tools/generate_md5_baseline.py`, `python tools/generate_seo_baseline.py --output snapshot/seo_baseline.json.gz`; `.gitignore` обновлён, diff страницы открываются мгновенно | ✅ Огромные файлы исключены из git, baseline генерируется по запросу. |
| 2025-09-23T18:31:55Z | B1 — собрана карта зависимостей (`tools/list_assets.py`) | Прогон: `python tools/list_assets.py` → `artifacts/assets.json`, проверка объёма (`head artifacts/assets.json`) | ✅ Получен отчёт по 2169 HTML-файлам, готов к анализу перед переносом структуры. |
| 2025-09-23T19:17:37Z | B2 — разработан и опробован `tools/check_links.py` | `python tools/check_links.py --scope nlping.ru/index.html` → `logs/check_links-20250923T191737Z.json` | ⚠️ Скрипт выявил отсутствующий `s.nlping.ru/jsapi/click.js`; инструмент готов для дальнейших проверок. |
| 2025-09-23T20:00:35Z | B2 — удалена устаревшая hop-интеграция и повторно прогнан `tools/check_links.py` | `python tools/check_links.py --scope nlping.ru/index.html` → `logs/check_links-20250923T200035Z.json` | ✅ Проверка проходит, база очищена от битых ресурсов. |

## Текущее состояние дорожной карты

- ✅ A1: дорожная карта зафиксирована (этот документ).
- ✅ A2: baseline контрольных сумм генерируется скриптом (`python tools/generate_md5_baseline.py` → `snapshot/baseline_md5.txt.gz`, вне git).
- ✅ A3: подготовлен манифест ключевых URL (`tools/url_manifest.txt`).
- ✅ A5: памятки memory-bank созданы (`memory-bank/MB-*.md`).
- ✅ A4: оффлайн-слепок и SEO-бейзлайн создаются локально (`snapshot/` содержит только `.gitkeep`, артефакты генерируются по запросу).
- ✅ B1: создан и выполнен `tools/list_assets.py`, отчёт в `artifacts/assets.json`.
- ✅ B2: `tools/check_links.py` подтверждает отсутствие битых ресурсов (`logs/check_links-20250923T200035Z.json`), устаревший hop-скрипт удалён.
- ⏳ Остальные шаги (B3–E4) не начаты.

Следующий шаг: B3 — разработать `tools/check_utf8.py` для проверки кодировки и SEO-блоков.
